<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>

<head>
  <title>Stratosphere JobManager</title>

  <meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <link rel="stylesheet" type="text/css" href="css/nephelefrontend.css">

  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/jcanvas.min.js"></script>
  <script type="text/javascript" src="js/jquery.flot.min.js"></script>
  <script type="text/javascript" src="js/jquery.flot.pie.min.js"></script>

  <script type="text/javascript">
		var jsonGlobal;
		var widthProgressbar = 120;
		(function poll() {
		    $.ajax({
		        url: "/jobsInfo",
		        type: "GET",
		        success: function(json) {
		        	jsonGlobal = json
		        	// Fill Table	
				fillTable("#jobs", json)
		        },
		        dataType: "json",
		        //complete: setTimeout(function() {poll()}, 5000),
		        //timeout: 2000
		    }); 
		})();


		(function pollArchive() {
		    $.ajax({
		        url: "/jobsInfo?get=archive",
		        type: "GET",
		        success: function(json) {
		        	// Fill Table	
				fillTableArchive("#jobsArchive", json)
		        },
		        dataType: "json",
		        //complete: setTimeout(function() {poll()}, 5000),
		        //timeout: 2000
		    }); 
		})();

		(function pollTaskmanagers() {
		    $.ajax({
		        url: "/jobsInfo?get=taskmanagers",
		        type: "GET",
		        success: function(json) {
		        	$("#stat-taskmanagers").html(json.taskmanagers);
		        },
		        dataType: "json",
		        //complete: setTimeout(function() {poll()}, 5000),
		        //timeout: 2000
		    }); 
		})();

		/*
		* Toggle ExecutionVectors
		*/
		$(".opensub").live("click", function() {
			var id = $(this).attr("open");
			$("#"+id).toggle();
			drawDependencies();
		});

		$(".cancel").live("click", function() {
			var id = $(this).attr("job");
			$.ajax({
		        url: "/jobsInfo?get=cancel&job="id,
		        type: "GET",
		        success: function(json) {
		        	
		        }
		        //complete: setTimeout(function() {poll()}, 5000),
		        //timeout: 2000
		    }); 
		});
		
		/*
		* Draw graph on left side beside table
		*/
		function drawDependencies() {
			$.each(jsonGlobal, function(i, job) {
			 $("#dependencies"+job.jobid).clearCanvas();
		             $("#dependencies"+job.jobid).attr("height", 10);
		             $("#dependencies"+job.jobid).attr("height", ($("#"+job.jobid).height()));
		             $.each(job.groupvertices, function(j, groupvertex) {
		             		edgeCount = 0;
		             		$.each(groupvertex.backwardEdges, function(k, edge) {
		             			 var y1 = ($("#"+edge.groupvertexid).offset().top - $("#dependencies"+job.jobid).offset().top)+15;
		             			 var y2 = ($("#"+groupvertex.groupvertexid).offset().top - $("#dependencies"+job.jobid).offset().top)+15;
		             			 var cy1 = y1 + (y2 - y1) / 2;
		             			 //var cx1 = 70 - (edgeCount / groupvertex.numberofgroupmembers) * 140;
		             			 var cx1 = 0;
								 edgeCount++;
		             			 
		             			 var strokeWidth = 2;
		             			 if(edge.channelType == "NETWORK")
		             			 	var strokeWidth = 4;
		             			 
		             			 $("#dependencies"+job.jobid).drawQuadratic({
									  strokeStyle: "#57697E",
									  strokeWidth: strokeWidth,
									  x1: 100, y1: y1, // Start point
									  cx1: cx1, cy1: cy1, // Control point
									  x2: 100, y2: y2 // End point
									});
		             		});
		             	});
		             });
		
		}

		function fillTable(table, json) {
		$(table).html("");

		             $.each(json, function(i, job) {
					    var countGroups = 0;
						var countTasks = 0;
						var countStarting = 0;
						var countRunning = 0;
						var countFinished = 0;
						var countCanceled = 0;
						var countFailed = 0;
		             	$(table).append("<h2>"+job.jobname+" <span style=\"text-decoration: none\">(time: "+formattedTimeFromTimestamp(job.time)+")</span></h2><a class=\"cancel\" href=\"#\" job=\""+job.jobid+"\">cancel</a><br />");
		             	var jobtable;
		             	jobtable = "<table id=\""+job.jobid+"\">\
											  	<tr>\
											  		<th>Name</th>\
											  		<th>Tasks</th>\
											  		<th>Starting</th>\
											  		<th>Running</th>\
											  		<th>Finished</th>\
											  		<th>Canceled</th>\
											  		<th>Failed</th>\
											  	</tr>";
						
						$.each(job.groupvertices, function(j, groupvertex) {
							countGroups++;
							countTasks += groupvertex.numberofgroupmembers;
							countStarting += (groupvertex.CREATED+groupvertex.SCHEDULED+groupvertex.ASSIGNED+groupvertex.READY+groupvertex.STARTING);
							countRunning += groupvertex.RUNNING;
							countFinished += groupvertex.FINISHING+groupvertex.FINISHED;
							countCanceled += groupvertex.CANCELING+groupvertex.CANCELED;
							countFailed += groupvertex.FAILED;
		             		jobtable += "<tr>\
		             							<td id=\""+groupvertex.groupvertexid+"\"><span class=\"opensub\" open=\"_"+groupvertex.groupvertexid+"\">"+groupvertex.groupvertexname+"</span></td>\
		             							<td>"+groupvertex.numberofgroupmembers+"</td>\
		             							<td class=\"starting\"><div class=\"progressBar\"><div style=\"width:"+((groupvertex.CREATED+groupvertex.SCHEDULED+groupvertex.ASSIGNED+groupvertex.READY+groupvertex.STARTING)/groupvertex.numberofgroupmembers)*widthProgressbar+"px\">"+(groupvertex.CREATED+groupvertex.SCHEDULED+groupvertex.ASSIGNED+groupvertex.READY+groupvertex.STARTING)+"</div></div></td>\
		             							<td class=\"running\"><div class=\"progressBar\"><div style=\"width:"+(groupvertex.RUNNING / groupvertex.numberofgroupmembers) *widthProgressbar+"px\">"+groupvertex.RUNNING+"</div></div></td>\
		             							<td class=\"finished\"><div class=\"progressBar\"><div style=\"width:"+((groupvertex.FINISHING+groupvertex.FINISHED)/groupvertex.numberofgroupmembers)*widthProgressbar+"px\">"+(groupvertex.FINISHING+groupvertex.FINISHED)+"</div></div></td>\
		             							<td class=\"canceled\"><div class=\"progressBar\"><div style=\"width:"+((groupvertex.CANCELING+groupvertex.CANCELED)/groupvertex.numberofgroupmembers)*widthProgressbar+"px\">"+(groupvertex.CANCELING+groupvertex.CANCELED)+"</div></div></td>\
		             							<td class=\"failed\"><div class=\"progressBar\"><div style=\"width:"+(groupvertex.FAILED / groupvertex.numberofgroupmembers) *widthProgressbar+"px\">"+groupvertex.FAILED+"</div></div></td>\
		             							</tr>\
		             							<td colspan=8 id=\"_"+groupvertex.groupvertexid+"\" style=\"display:none\">\
		             							<table class=\"subtable\">\
											  	<tr>\
											  		<th>Name</th>\
											  		<th>status</th>\
											  		<th>instancename</th>\
											  		<th>instancetype</th>\
											  	</tr>";
							$.each(groupvertex.groupmembers, function(k, vertex) {
								jobtable += "<tr>\
			             							<td>"+vertex.vertexname+"</td>\
			             							<td>"+vertex.vertexstatus+"</td>\
			             							<td>"+vertex.vertexinstancename+"</td>\
			             							<td>"+vertex.vertexinstancetype+"</td>\
			             							</tr>";
							});		
		             		jobtable += "</table></td></tr>";
		             	});
						
						jobtable += "<tr>\
										<td colspan=\"2\" align=\"center\">Sum</td>\
										<td>"+countTasks+"</td>\
										<td class=\"starting\"><div class=\"progressBar\"><div style=\"width:"+(countStarting/countTasks)*widthProgressbar+"px\">"+countStarting+"</div></div></td>\
										<td class=\"running\"><div class=\"progressBar\"><div style=\"width:"+(countRunning / countTasks) *widthProgressbar+"px\">"+countRunning+"</div></div></td>\
										<td class=\"finished\"><div class=\"progressBar\"><div style=\"width:"+(countFinished/countTasks)*widthProgressbar+"px\">"+countFinished+"</div></div></td>\
										<td class=\"canceled\"><div class=\"progressBar\"><div style=\"width:"+(countCanceled/countTasks)*widthProgressbar+"px\">"+countCanceled+"</div></div></td>\
										<td class=\"failed\"><div class=\"progressBar\"><div style=\"width:"+(countFailed / countTasks) *widthProgressbar+"px\">"+countFailed+"</div></div></td>\
									</tr>";
						
		             	jobtable += "</table>"
		             	$(table).append(jobtable);
						$("#"+job.jobid).prepend("<tr><td width=\"100\" rowspan="+(countGroups*2+2)+"><canvas id=\"dependencies"+job.jobid+"\" height=\""+($("#"+job.jobid).height())+"\" width=\"100\"></canvas></td>");
		             });
		             drawDependencies(json);

		}


		function fillTableArchive(table, json) {
		     $(table).html("");
		     var finished = 0;
		     var failed = 0;
		     var canceled = 0;
	             $.each(json, function(i, job) {
	             	$(table).append("<li><a href=\"/analyze.html?job="+job.jobid+"\">"+job.jobname+" (time: "+formattedTimeFromTimestamp(job.time)+")</a></li>");
			if(job.status == "FINISHED")
				finished++;
			if(job.status == "FAILED")
				failed++;
			if(job.status == "CANCELED")
				canceled++;
	             });
			$("#jobs-finished").html(finished);
			$("#jobs-failed").html(failed);
			$("#jobs-canceled").html(canceled);
		}

function formattedTimeFromTimestamp(timestamp)
{
    var date = new Date(timestamp);
    return date.toLocaleString();
}
	
  </script>
</head>

<body>

<div id="page-sidebar">
                <div id="header-logo">
                    <img width="250" alt="Stratosphere Logo" src="img/StratosphereLogo.png"> <i class="opacity-80">v2.0</i>
                </div>

                <div class="scrollable-content active" id="sidebar-menu" style="overflow: hidden; height: 130px;" tabindex="5000">
                    <ul style="">
                        <li class="current-page">
                            <a title="Dashboard" href="index.html">
                                Job Manager
                            </a>
                        </li>
                        <li>
                            <a title="Components"target="_blank"  href="/logInfo">
                                Log
                            </a>
                        </li>
			<li>
                            <a title="Components"target="_blank"  href="/logInfo?get=stdout">
                                Stdout
                            </a>
                        </li>
                    </ul>
                </div>
</div>

<div id="page-main">
<div id="page-main-wrapper">
<div id="page-content">

    <!--<div class="mainHeading" style="min-width: 950x;">
      <h1><img src="img/StratosphereLogo.png" width="326" height="100" alt="Stratosphere Logo" />Stratosphere JobManager</h1>
    </div>-->

    <!-- the main panel with the jobs list and the preview pane -->


    <div class="contentbox">
<h3 class="contentbox-header">
<span>Running Jobs</span>
</h3>
<div id="jobs" class="contentbox-wrapper">

</div></div>

<div class="col2">
    <div class="contentbox">
<h3 class="contentbox-header">
<span>Old Jobs</span>
</h3>
<div class="contentbox-wrapper">
<ul id="jobsArchive">
</ul>
</div></div>
</div>

<div class="col2 col2-2">
    <div class="contentbox">
<h3 class="contentbox-header">
<span>Statistics</span>
</h3>
<div class="contentbox-wrapper">

<div class="infobox border-green">
                    <b>Task Managers</b>
                    <span id="stat-taskmanagers" class="stats">
                    </span>
                </div>

<div class="infobox border-orange">
                    <b>Finished</b>
                    <span id="jobs-finished" class="stats">
                    </span>
                </div>

<div class="infobox border-blue">
                    <b>Failed</b>
                    <span id="jobs-failed"  class="stats">
                    </span>
                </div>

<div class="infobox border-red">
                    <b>Canceled</b>
                    <span id="jobs-canceled"  class="stats">
                    </span>
                </div>
<br style="clear: both" />
</div></div>
</div>
<br style="clear: both" />

</div></div></div>
</body>
</html>
